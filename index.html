<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Happy Birthday Nannu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="file/default.css">
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#081b3e; }
    #wrap { position:relative; width:100vw; height:100vh; }
    canvas { display:block; width:100vw; height:100vh; }
    #clock-box { position:absolute; top:2.5vh; left:5vw; color:#fff; z-index:3;
                 font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; font-size:18px; }
    #clock { font-weight:600; }
    #text { position:absolute; top:14vh; left:5vw; width:72vw; max-width:560px; color:#fff; z-index:3; }
    #code { display:none; line-height:1.35; font-size:14px; font-family:system-ui, Arial; }
    @media (max-width:420px){
      #clock-box{font-size:16px; top:1.8vh; left:4.5vw;}
      #text{top:16vh; left:4.5vw; width:78vw; font-size:13px;}
    }
  </style>

  <!-- Libraries (paths must match exact filenames in file/) -->
  <script src="file/jquery.min.js"></script>
  <script src="file/jscex.min.js"></script>
  <script src="file/jscex-parser.js"></script>
  <script src="file/jscex-jit.js"></script>
  <script src="file/jscex-builderbase.min.js"></script>
  <script src="file/jscex-async.min.js"></script>
  <script src="file/jscex-async-powerpack.min.js"></script>
  <script src="file/functions.js"></script>
  <script src="file/love.js"></script>
</head>
<body>
  <!-- Audio (plays on first tap) -->
  <audio id="myAudio">
    <source src="aud.mp3" type="audio/mpeg">
  </audio>

  <div id="wrap">
    <div id="clock-box"><span id="clock">Loadingâ€¦</span></div>

    <div id="text">
      <div id="code">
        <span class="say">Nanuu ðŸ¥ºðŸ¥ºðŸ¥º Mere Bachee Mere ZuvuuðŸ’ž</span><br>
        <span class="say">Happy Birthday Very Very Happy Birthday JaanðŸŽˆ</span><br>
        <span class="say">Aap hamesha khush raho, hamesha happy happy raho. I miss you.</span><br>
        <span class="say">May Allah bless you and give you many happiness. ðŸ’•</span><br>
        <span class="say">Mera pyara bacha â€” my world, my universe, my everything.</span><br>
        <span class="say">Apna khayaal rakha karo, Nannuuu ðŸ¥º</span><br>
        <span class="say">Hope you have a great day today â€” Happy Birthday once again, Nannu!</span><br>
      </div>
    </div>

    <canvas id="canvas"></canvas>
  </div>

  <script>
    // 1) Responsive canvas
    const $canvas = $('#canvas');
    function sizeCanvas(){
      $canvas.attr('width', window.innerWidth);
      $canvas.attr('height', window.innerHeight);
    }
    sizeCanvas();
    addEventListener('resize', sizeCanvas);
    addEventListener('orientationchange', sizeCanvas);

    // 2) Mobile audio: play on first touch/click
    (function enableAudioOnce(){
      const audio = document.getElementById('myAudio');
      const start = () => { audio.play().catch(()=>{}); removeEventListener('click', start); removeEventListener('touchstart', start); };
      addEventListener('click', start, {passive:true});
      addEventListener('touchstart', start, {passive:true});
    })();

    // 3) Countdown to next birthday (set month/day below)
    (function clockCounter(){
      const span = document.getElementById('clock');
      function nextBirthday(month, day){
        const now = new Date();
        let y = now.getFullYear();
        let t = new Date(y, month-1, day, 0, 0, 0);
        if (t < now) t = new Date(y+1, month-1, day, 0, 0, 0);
        return t;
      }
      const target = nextBirthday(9, 30); // CHANGE here: month, day
      function tick(){
        const now = new Date();
        let diff = Math.max(0, target - now);
        const d = Math.floor(diff / 86400000);
        diff %= 86400000;
        const h = Math.floor(diff / 3600000);
        diff %= 3600000;
        const m = Math.floor(diff / 60000);
        diff %= 60000;
        const s = Math.floor(diff / 1000);
        span.textContent = d + " days " + h + " hours " + m + " minutes " + s + " seconds";
        setTimeout(tick, 500);
      }
      tick();
    })();

    // 4) Heart tree animation (uses Tree from functions.js/love.js)
    (function () {
      if (!$canvas[0].getContext) return;

      const width = $canvas.width();
      const height = $canvas.height();

      const opts = {
        seed: { x: width/2 - 20, color: "rgb(190,26,37)", scale: 2 },
        branch: [
          [535, 680, 570, 250, 500, 200, 30, 100, [
            [540, 500, 455, 417, 340, 400, 13, 100, [
              [450, 435, 434, 430, 394, 395, 2, 40]
            ]],
            [550, 445, 600, 356, 680, 345, 12, 100, [
              [578, 400, 648, 409, 661, 426, 3, 80]
            ]],
            [539, 281, 537, 248, 534, 217, 3, 40],
            [546, 397, 413, 247, 328, 244, 9, 80, [
              [427, 286, 383, 253, 371, 205, 2, 40],
              [498, 345, 435, 315, 395, 330, 4, 60]
            ]],
            [546, 357, 608, 252, 678, 221, 6, 100, [
              [590, 293, 646, 277, 648, 271, 2, 80]
            ]]
          ]]
        ],
        bloom: { num: 700, width: width, height: height - 30 },
        footer: { width: width, height: 5, speed: 10 }
      };

      const tree = new Tree($canvas[0], width, height, opts);
      const seed = tree.seed, foot = tree.footer;
      let hold = 0; // start automatically

      // Optional: let user tap to replay audio; animation no longer blocked
      $canvas.on('click touchstart', function(){ /* keep */ });

      const seedAnimate = eval(Jscex.compile("async", function () {
        seed.draw();
        while (hold) { $await(Jscex.Async.sleep(10)); }
        while (seed.canScale()) { seed.scale(0.95); $await(Jscex.Async.sleep(10)); }
        while (seed.canMove()) { seed.move(0, 2); foot.draw(); $await(Jscex.Async.sleep(10)); }
      }));

      const growAnimate = eval(Jscex.compile("async", function () {
        do { tree.grow(); $await(Jscex.Async.sleep(10)); } while (tree.canGrow());
      }));

      const flowAnimate = eval(Jscex.compile("async", function () {
        do { tree.flower(2); $await(Jscex.Async.sleep(10)); } while (tree.canFlower());
      }));

      const moveAnimate = eval(Jscex.compile("async", function () {
        tree.snapshot("p1", 240, 0, Math.min(610, width-240), height);
        while (tree.move("p1", Math.min(500, width-500), 0)) {
            foot.draw(); $await(Jscex.Async.sleep(10));
        }
        foot.draw();
        tree.snapshot("p2", Math.min(500, width-500), 0, Math.min(610, width-240), height);
        $canvas.parent().css("background", "url(" + tree.toDataURL('image/png') + ")");
        $canvas.css("background", "#ffe");
        $await(Jscex.Async.sleep(300));
        $canvas.css("background", "none");
      }));

      const textAnimate = eval(Jscex.compile("async", function () {
        $("#code").show().typewriter();
      }));

      const runAsync = eval(Jscex.compile("async", function () {
        $await(seedAnimate());
        $await(growAnimate());
        $await(flowAnimate());
        $await(moveAnimate());
        textAnimate().start();
      }));

      runAsync().start();
    })();
  </script>
</body>
</html>
