<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Happy Birthday</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="file/default.css">
  <style>
    html,body{margin:0;height:100%;background:#081b3e;overflow:hidden}
    #wrap{position:relative;width:100vw;height:100vh}
    #clock-box{position:absolute;top:14px;left:16px;color:#fff;z-index:3;font:600 16px system-ui,Arial}
    #text{position:absolute;top:80px;left:16px;color:#fff;z-index:3;font:14px system-ui,Arial}
    #code{display:none;line-height:1.35}
    canvas{display:block;width:100vw;height:100vh}
    #err{position:fixed;left:0;right:0;top:0;background:#ff3860;color:#fff;padding:8px;font:14px system-ui,Arial;display:none;z-index:9}
  </style>
</head>
<body>
  <div id="err"></div>

  <div id="wrap">
    <div id="clock-box"><span id="clock">Loadingâ€¦</span></div>
    <div id="text">
      <div id="code">
        <span class="say">Nanuu ðŸ¥ºðŸ¥ºðŸ¥º Mere Bachee Mere ZuvuuðŸ’ž</span><br>
        <span class="say">Happy Birthday Very Very Happy Birthday JaanðŸŽˆ</span><br>
        <span class="say">Aap hamesha khush raho. I miss you.</span><br>
        <span class="say">May Allah bless you with happiness. ðŸ’•</span><br>
        <span class="say">My world, my universe, my everything.</span><br>
        <span class="say">Apna khayaal rakha karo, Nannuuu ðŸ¥º</span><br>
        <span class="say">Happy Birthday once again!</span><br>
      </div>
    </div>
    <canvas id="canvas"></canvas>
  </div>

  <audio id="myAudio"><source src="aud.mp3" type="audio/mpeg"></audio>

  <!-- Original libraries, exact filenames -->
  <script src="file/jquery.min.js"></script>
  <script src="file/jscex.min.js"></script>
  <script src="file/jscex-parser.js"></script>
  <script src="file/jscex-jit.js"></script>
  <script src="file/jscex-builderbase.min.js"></script>
  <script src="file/jscex-async.min.js"></script>
  <script src="file/jscex-async-powerpack.min.js"></script>
  <script src="file/functions.js"></script>
  <script src="file/love.js"></script>

  <script>
    // Show first error if any file fails to load
    (function(){ const b=document.getElementById('err');
      addEventListener('error',e=>{ b.style.display='block'; b.textContent=e.message||'A script failed to load'; });
    })();

    // 1) Responsive canvas sizing only (no transforms)
    const $win = $(window), $canvas = $('#canvas');
    function fitCanvas(){
      $canvas.attr('width', window.innerWidth);
      $canvas.attr('height', window.innerHeight);
    }
    fitCanvas(); $win.on('resize orientationchange', fitCanvas);

    // 2) Original options from the source (unchanged coordinates)
    const opts = {
      seed: { x: 550 - 20, color: "rgb(190, 26, 37)", scale: 2 },
      branch: [
        [535, 680, 570, 250, 500, 200, 30, 100, [
          [540, 500, 455, 417, 340, 400, 13, 100, [
            [450, 435, 434, 430, 394, 395, 2, 40]
          ]],
          [550, 445, 600, 356, 680, 345, 12, 100, [
            [578, 400, 648, 409, 661, 426, 3, 80]
          ]],
          [539, 281, 537, 248, 534, 217, 3, 40],
          [546, 397, 413, 247, 328, 244, 9, 80, [
            [427, 286, 383, 253, 371, 205, 2, 40],
            [498, 345, 435, 315, 395, 330, 4, 60]
          ]],
          [546, 357, 608, 252, 678, 221, 6, 100, [
            [590, 293, 646, 277, 648, 271, 2, 80]
          ]]
        ]]
      ],
      bloom: { num: 700, width: 1080, height: 650 },
      footer: { width: 1200, height: 5, speed: 10 }
    };

    // 3) Original animation with ONE mobile tweak:
    //    Play audio in the same tap that releases the heart.
    (function () {
      const canvas = $canvas;
      if (!canvas[0].getContext) return;

      // sizes set by fitCanvas()
      const width = canvas.width();
      const height = canvas.height();
      canvas.attr("width", width);
      canvas.attr("height", height);

      const tree = new Tree(canvas[0], width, height, opts);
      const seed = tree.seed;
      const foot = tree.footer;
      let hold = 1;

      function startFromTap(){
        // release heart
        if (hold){ hold = 0; }
        // start music (same gesture satisfies mobile autoplay)
        const audio = document.getElementById('myAudio');
        audio.loop = true;
        const p = audio.play(); if (p && p.catch) p.catch(()=>{});
        // remove listeners after first gesture
        canvas.off('click touchstart', startFromTap);
      }

      canvas.on('click touchstart', function(e){
        const offset = canvas.offset(), x = e.originalEvent.touches ? e.originalEvent.touches[0].pageX - offset.left : e.pageX - offset.left;
        const y = e.originalEvent.touches ? e.originalEvent.touches[0].pageY - offset.top : e.pageY - offset.top;
        // keep original hover behavior (optional)
        startFromTap();
      });

      const seedAnimate = eval(Jscex.compile("async", function () {
        seed.draw();
        while (hold) { $await(Jscex.Async.sleep(10)); }
        while (seed.canScale()) { seed.scale(0.95); $await(Jscex.Async.sleep(10)); }
        while (seed.canMove()) { seed.move(0, 2); foot.draw(); $await(Jscex.Async.sleep(10)); }
      }));

      const growAnimate = eval(Jscex.compile("async", function () {
        do { tree.grow(); $await(Jscex.Async.sleep(10)); } while (tree.canGrow());
      }));

      const flowAnimate = eval(Jscex.compile("async", function () {
        do { tree.flower(2); $await(Jscex.Async.sleep(10)); } while (tree.canFlower());
      }));

      const moveAnimate = eval(Jscex.compile("async", function () {
        tree.snapshot("p1", 240, 0, 610, 680);
        while (tree.move("p1", 500, 0)) {
          foot.draw();
          $await(Jscex.Async.sleep(10));
        }
        foot.draw();
        tree.snapshot("p2", 500, 0, 610, 680);

        canvas.parent().css("background", "url(" + tree.toDataURL('image/png') + ")");
        canvas.css("background", "#ffe");
        $await(Jscex.Async.sleep(300));
        canvas.css("background", "none");
      }));

      const textAnimate = eval(Jscex.compile("async", function () {
        $("#code").show().typewriter();
      }));

      const runAsync = eval(Jscex.compile("async", function () {
        $await(seedAnimate());
        $await(growAnimate());
        $await(flowAnimate());
        $await(moveAnimate());
        textAnimate().start();
      }));

      runAsync().start();

      // CLOCK (running time or countdown â€” here a simple countdown to next birthday)
      (function clockCounter(){
        const span=document.getElementById('clock');
        function nextBirthday(m,d){ const n=new Date(); let y=n.getFullYear(); let t=new Date(y,m-1,d,0,0,0); if(t<n) t=new Date(y+1,m-1,d,0,0,0); return t; }
        const target=nextBirthday(9,30); // change month/day
        function tick(){
          const n=new Date(); let diff=Math.max(0,target-n);
          const D=Math.floor(diff/86400000); diff%=86400000;
          const H=Math.floor(diff/3600000); diff%=3600000;
          const M=Math.floor(diff/60000); diff%=60000;
          const S=Math.floor(diff/1000);
          span.textContent = D+" days "+H+" hours "+M+" minutes "+S+" seconds";
          setTimeout(tick,500);
        }
        tick();
      })();
    })();
  </script>
</body>
</html>
